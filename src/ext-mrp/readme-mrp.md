# Алгоритм планирования ресурсов - MRP

Для работы алгоритма необходимо внесение следующих основных данных:

* **ресурсы**: материалы и сырье, которые используются в производстве продуктов
* **продукты**: перечень продукции, производство которой планируется
* **этапы**: схема производства продукции
* **остатки ресурсов**: сколько ресурсов было на начало периода и сколько ресурсов находится в процессе 
доставки и прибудет несколько позднее начальной даты планирования; по результатам планирования записываются 
планируемые поставки ресурсов 
* **остатки продукции**: сколько готовой продукции было на складе на начало периода, и какие партии 
продукции находятся в производстве на начало периода; по результатам планирования записывается планируемые
партии производства
* **план**: это основные исходные данные алгоритма планирования - план продаж, сформулированный в виде количества 
продукции, которое нужно для сбыта в указанные даты.

## Ресурсы . MrpResource
 
Ресурсы - это материалы и сырье. Описание ресурса включает в себя:

* id: идентификатор ресурса
* caption: название ресурса
* unit: название единицы измерения ресурса
* minStock: минимальный остаток ресурсов, при котором заказывается следующая партия


Методы:
* обработать ресурсы в транспортировке - сформировать регистр остаток ресурсов с учетом поступления 
ресурсов из транзита. Посмотреть остатки можно через ресурс "resource-stock"
* получить остатки ресурсов на определенную дату.
* сделать заказ сырья к определенной дате: получить срок размещения заказа

## Алгоритм

Обрабатываем ресурсы в транзите. Формируем регистр остатков ресурсов на определенные 
даты с учётом транзита. (+)

Обрабатываем продукцию в производстве. Для каждой партии в производстве. Берем текущую 
партию. Берем этапы производства от самого первого до последнего. Для каждого этапа списываем 
ресурсы на производство продукции.

Сортируем план в хронологическом порядке. Обрабатываем каждую позицию 
плана от самой ранней к самой поздней. Вычисляем остаток продукции на эту дату. 
Вычисляем продажи к этой дате. 
Вычисляем производственный план. (+)

Берем текущую позицию производственного плана.  
Берем все этапы производства этой продукции. Сортируем в порядке следования прозводственных 
этапов, от самых первых этапов к последующим. 
Берем текущий этап. Производим вычисление даты начала этого этапа. Если дата меньше начальной 
даты в системе - пишем ошибку и прекращаем расчеты: система не может получить нужную продукцию 
к запланированной дате. 
Получаем список ресурсов, требуемых для данного этапа. 
Для каждого ресурса получаем остаток на дату начала этапа. Производим расчет требуемого объема ресурсов 
для данного производственного
этапа. Если остатки ресурсов не позволяют начать этап, производим планирование поставки партии ресурсов.
Берём новые остатки ресурсов с учётом запланированной поставки. 
Если остатки ресурсов позволяют произвести продукцию, сохраняем данные о себестоимости производства и 
фиксируем расход ресурсов на производство. 

Вычислить дату начала этапа: дата конечная, продукция, этап. Сортируем этапы хронологически. От самого 
последнего этапа начинаем. Отнимаем от даты конечной длительность текущего этапа. Если это требуемый этап -
возвращаем дату начала. Если этапы кончились - ошибка. Иначе - берем предшествующий этап.

Планирование поставки партии ресурсов: на входе - дата поступления ресурсов и требуемое количество. 
Справочно указываем основание заказа. Получаем длительность перевозки и изготовления требуемого 
ресурса для расчёта даты заказа. На эту дату 
получаем - какой поставщик и условия поставки будут действовать. В соответствии с этими условиями записываем 
финансовые планы и требуемое количество ресурса для заказа. Записываем в список партий ресурсов эту партию
как заказанную (planned order). Основание заказа - продукция, этап. 

Получить остаток ресурсов на дату: берем перечень всех партий ресурсов в хронологическом 
порядке - от начальных остатков, остатков в транзите, и спланированных поставок. Далее получаем 
список всех расходных операций на дату. Соотносим приходные операции и расходные операции. Оставляем 
список всех партий, у которых остаток получился положительный - его и возвращем.

Списать ресурсы на призодство: продукция, этап, дата начала этапа. Берем список ресурсов, требуемый
для данного этапа. Для каждого ресурса берем текущий ресурс. Получаем остатки этого ресурса на дату. 
Делаем расчет требуемого количества ресурса на производство. Если ресурса не хватает - пишем об ошибке.
Если ресурса хватает, то для каждой партии ресурса на складе списываем имеющееся колчиество ресурсов 
из этой партии до тех пор, пока не наберем требуемое количество ресурсов.
   
## Важные замечания

Алгоритм не учитывает планирование продаж - план представляет собой сразу план производственных партий. 
Для учета плана продаж необходима агрегация планов продаж из различных источников, планирование остатка 
продукции, соотнесение их с планом продаж и планирование производственных партий.
   
## Примечания

(!) какие нюансы необходимо подумать: если в технологической карте есть этапы, которые могут 
идти параллельно. Для этого указываем дни от начала производства для старта этапа. График 
производства составляем в порядке старта различных этапов.
(!) этапы производства могут быть связаны в цепочки (указывается предыдущий этап) и идти друг 
за другом. При этом могут существовать цепочки, которые идут параллельно друг с другом.
(!) исходные данные для процесса планирования: 
    - количество продукции, которое должно быть передано на склад готовой продукции от 
производства в склад в определенные даты.
    - количество ресурсов на складе;
    - транзит ресурсов;
(!) результат планирования: 
    - перечень партий продукции, которые будут произведены; для каждой партии указывается 
точная себестоимость продукции;
    - перечень партий сырья и материалов, которые будут приобретены - указание стоимости и 
суммы приобретения;
(!) указание приоритета при выборе поставщика сырья или материалов: можно указать приоритет 
по цене, можно - по срокам поставки, можно - по минимальной стоимости партии (общая сумма 
закупки). Приоритеты могут быть установлены на определенную дату.
(!) функции перепланирования:
    - партия товара задерживается, 
    - невозможность поставки отдельной партии ресурсов. 
В результате перепланирования указывается отклонение от первоначального плана - попозиционно, 
с указанием отклонения по себестоимости.

## BT MRP Server 2

Делаем апгрейд проекта:

* переводим сервер под express (или fastify?)
* вводим систему тестов - пишем тестовые сценарии
* делаем клиентское приложение на react admin на базе CRM 
  1) справочники, "компании", "продукты", "ресурсы"
  2) делаем систему интеграционных тестов;
  3) подключаем алгоритм генерации отчетов по ресурсам - MRP

